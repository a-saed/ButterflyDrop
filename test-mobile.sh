#!/bin/bash

# ðŸ¦‹ Butterfly Drop - Local Mobile Testing Script
# This script helps you test the app on your mobile device

set -e

echo "ðŸ¦‹ Butterfly Drop - Mobile Testing Setup"
echo "========================================"
echo ""

# Get local IP address
if command -v hostname &> /dev/null; then
    LOCAL_IP=$(hostname -I | awk '{print $1}')
elif command -v ip &> /dev/null; then
    LOCAL_IP=$(ip addr show | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}' | cut -d/ -f1 | head -1)
else
    echo "âŒ Could not detect IP address automatically"
    echo "Please enter your laptop's IP address manually:"
    read LOCAL_IP
fi

echo "ðŸ“± Your laptop's IP address: $LOCAL_IP"
echo ""

# Update .env.local with correct IP
echo "ðŸ“ Creating .env.local with your IP..."
cat > .env.local << EOF
# Local Development Environment - LAN Testing
# Auto-generated by test-mobile.sh

# Your laptop's local IP address
VITE_SIGNALING_URL=ws://$LOCAL_IP:8080

# For production deployment, use .env with wss:// URL
EOF

echo "âœ… Created .env.local"
echo ""

# Rebuild server
echo "ðŸ”¨ Building server..."
cd server
pnpm build
cd ..
echo "âœ… Server built"
echo ""

# Kill existing processes
echo "ðŸ§¹ Cleaning up existing processes..."
pkill -f "node.*dist/index.js" 2>/dev/null || true
pkill -f "vite" 2>/dev/null || true
pkill -f "pnpm.*dev" 2>/dev/null || true
sleep 2

# Start server in background
echo "ðŸš€ Starting signaling server..."
cd server
node dist/index.js > ../server.log 2>&1 &
SERVER_PID=$!
cd ..
sleep 2

# Check if server started
if ps -p $SERVER_PID > /dev/null; then
    echo "âœ… Server started (PID: $SERVER_PID)"
else
    echo "âŒ Server failed to start. Check server.log for errors"
    exit 1
fi

# Start frontend
echo "ðŸŽ¨ Starting frontend..."
echo "   Using signaling URL: ws://$LOCAL_IP:8080"
# Use nohup to ensure process stays alive and redirect output properly
# Clear any cached env vars by explicitly setting it
export VITE_SIGNALING_URL="ws://$LOCAL_IP:8080"
nohup pnpm dev > frontend.log 2>&1 &
FRONTEND_PID=$!
sleep 5

# Check if frontend started (check for vite process)
if pgrep -f "vite" > /dev/null; then
    echo "âœ… Frontend started (PID: $FRONTEND_PID)"
    echo "   Checking if Vite is listening..."
    sleep 2
    if curl -s http://localhost:5173 > /dev/null 2>&1; then
        echo "   âœ… Vite is responding on localhost:5173"
    else
        echo "   âš ï¸  Vite may still be starting, wait a few seconds..."
    fi
else
    echo "âŒ Frontend failed to start. Check frontend.log for errors"
    echo "   Last 10 lines of frontend.log:"
    tail -10 frontend.log
    kill $SERVER_PID 2>/dev/null || true
    exit 1
fi

echo ""
echo "=========================================="
echo "ðŸŽ‰ Setup Complete! Ready to test!"
echo "=========================================="
echo ""
echo "ðŸ“± Open on your mobile device:"
echo "   http://$LOCAL_IP:5173"
echo ""
echo "ðŸ’» Open on your laptop:"
echo "   http://localhost:5173"
echo ""
echo "ðŸ” Test servers:"
echo "   Frontend: curl http://localhost:5173"
echo "   Signaling: curl http://$LOCAL_IP:8080/health"
echo ""
echo "ðŸ“Š View logs:"
echo "   tail -f server.log     (server logs)"
echo "   tail -f frontend.log   (frontend logs)"
echo ""
echo "ðŸ›‘ To stop servers:"
echo "   kill $SERVER_PID $FRONTEND_PID"
echo "   OR press Ctrl+C and run: pkill -f 'node.*dist/index.js' && pkill -f vite"
echo ""
echo "âš ï¸  Troubleshooting:"
echo "   - Make sure your mobile is on the same WiFi network"
echo "   - Check firewall: sudo ufw allow 5173/tcp"
echo "   - Check firewall: sudo ufw allow 8080/tcp"
echo "   - If still not working, check frontend.log for errors"
echo ""

# Wait for user
echo "Press Ctrl+C to stop all servers..."
trap "echo ''; echo 'ðŸ›‘ Stopping servers...'; kill $SERVER_PID $FRONTEND_PID 2>/dev/null || true; echo 'âœ… Servers stopped'; exit 0" INT TERM

# Keep script running
wait
